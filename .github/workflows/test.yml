name: Summon Akochan

on:
  - push

env:
  NPROC: /usr/local/opt/coreutils/libexec/gnubin/nproc
  SED: /usr/local/opt/gnu-sed/libexec/gnubin/sed
  CLANGPP: clang++ # /usr/local/opt/llvm/bin/clang++

jobs:
  run:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Environment preparation
        run: |
          set -x

          git clone --depth=1 https://github.com/critter-mj/akochan.git
          git --git-dir=akochan/.git rev-parse --short HEAD | tee AKOCHAN_VER
          git clone --depth=1 https://github.com/Equim-chan/akochan-reviewer.git
          git --git-dir=akochan-reviewer/.git rev-parse --short HEAD

          brew update
          # brew upgrade llvm
          brew install gnu-sed coreutils boost libomp

          rustup toolchain update --no-self-update stable
          rustup default stable
          rustup show

          node --version
          yarn --version
          yarn global add html-minifier

          sysctl -a | grep machdep.cpu
          vm_stat

          rustc --version | tee RUSTC_VER
          $CLANGPP -E - -march=native -###
          $NPROC | tee NPROC

      - name: Cache akochan
        id: cache-akochan
        uses: actions/cache@v2
        with:
          path: |
            akochan/**/*.o
          # change it manually when needed
          key: ${{ runner.os }}-akochan-1-${{ hashFiles('NPROC') }}-${{ hashFiles('AKOCHAN_VER') }}
      - name: Cache akochan-reviewer
        id: cache-akochan-reviewer
        uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            akochan-reviewer/target
          # change it manually when needed
          key: ${{ runner.os }}-cargo-0-${{ hashFiles('RUSTC_VER') }}-${{ hashFiles('akochan-reviewer/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-0-${{ hashFiles('RUSTC_VER') }}-
            ${{ runner.os }}-cargo-0-

      - name: Build akochan
        run: |
          $SED -i \
            -e 's/CFLAGS =/CFLAGS = -march=native -ffast-math/' \
            -e 's@COMPILER =.*@COMPILER = /usr/bin/clang++@'
            -e '/-mllvm.*/d' \
            -e 's@-fopenmp/-Xpreprocessor -fopenmp -I$(LIBOMP_BASE)/include@g' \
            -e 's/LLVM_BASE =.*/LIBOMP_BASE = $(shell brew --prefix libomp)/' \
            -e 's@-L$(LLVM_BASE)/lib@-L$(LIBOMP_BASE)/lib@g' \
            akochan/Makefile_MacOS akochan/ai_src/Makefile_MacOS
          make -C akochan/ai_src -j$($NPROC) -f Makefile_MacOS
          make -C akochan -j$($NPROC) -f Makefile_MacOS
          otool -L akochan/{system.exe,libai.so}

      - name: Build akochan-reviewer
        env:
          RUSTFLAGS: -C target-cpu=native
        run: |
          cd akochan-reviewer
          cargo build --release

      - name: Run akochan-reviewer
        run: |
          source env.sh
          cd akochan-reviewer
          target/release/akochan-reviewer -v -d ../akochan --no-open -o ../report.html "${ARGS[@]}" || true
          export OMP_NUM_THREADS=$($NPROC)
          target/release/akochan-reviewer -v -d ../akochan --no-open -o ../report.html "${ARGS[@]}" || true

#      - name: Compress report
#        run: |
#          source env.sh
#          "$(yarn global bin)"/html-minifier -o "$OUTPUT" \
#            --collapse-whitespace \
#            --collapse-boolean-attributes \
#            --remove-optional-tags \
#            --remove-redundant-attributes \
#            --remove-script-type-attributes \
#            --remove-attribute-quotes \
#            --use-short-doctype \
#            --minify-css true \
#            --sort-attributes \
#            --sort-class-name \
#            report.html
#
#      - name: Publish report
#        run: |
#          echo DONE
